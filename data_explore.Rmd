---
title: "Exploration"
author: "Mariah Loehr"
date: "2024-06-10"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = 'hide')
library(tidyverse)
library(plotly)
library(packcircles)

taxon <- read.delim("taxon.txt") %>%
  na.omit() %>%
  pivot_longer(
    cols = X1:X103,
    names_to = "SampleID",
    values_to = "abondance"
  ) %>%
  mutate(SampleID = as.integer(str_sub(SampleID, 2))) %>%
  mutate(Percentage = abondance/100)

metadata <- read.delim("metadata.txt") %>%
  na.omit()

full_data <- metadata %>% 
  full_join(taxon, by = "SampleID")
```

```{r filter for specific id}
id = "1"
taxon_id <- taxon %>%
  filter(SampleID == id)
```

```{r donut chart phylum}
## phylum donut chart
phylum_data <- data_id %>%
  filter(str_detect(clade_name, "p_")) %>%
  filter(!str_detect(clade_name, "c_|o_|f_|g_|s_")) %>%
  mutate(ymax = cumsum(Percentage)) 

phylum_data <- phylum_data %>%
  mutate(ymin = c(0, head(phylum_data$ymax, n=-1)))

phylum_donut <- phylum_data %>%
  ggplot(aes(ymax=ymax, ymin=ymin, xmax = 4, xmin=3, fill = clade_name,
             text = paste(str_split(clade_name, "p_", simplify = T)[,2]))) +
  geom_rect() +
  coord_polar(theta = "y") +
  xlim(c(2,4)) +
  theme_void() +
  scale_fill_discrete()
  
# ggplotly(phylum_donut, tooltip = "text")
# 
# fig <- phylum_data %>% plot_ly(labls = ~clade_name, values = ~abondance)
# fig <- fig %>% add_pie(hole = 0.6)
# fig <- fig(layout(title = "Donut", showlegend = F,
#                   xaxis = list(showgrid = F, zeroline = F, showticklabels = F),
#                   yaxis = list(showgrid = F, zeroline = F, showticklabels = F)))
# 
# fig

## family donut chart (top 10)
family_data <- data_id %>%
  filter(str_detect(clade_name, "f_")) %>%
  filter(!str_detect(clade_name, "g_|s_")) %>%
  group_by(clade_name = ifelse(row_number() < 10, clade_name = "Other")) %>%
  summarise(across(c(abondance, Percentage), sum)) %>%
  mutate(ymax = cumsum(Percentage)) 
family_data <- family_data %>%
  mutate(ymin = c(0, head(family_data$ymax, n=-1)))

family_donut <- family_data %>%
  ggplot(aes(ymax=ymax, ymin=ymin, xmax = 4, xmin=3, fill = clade_name,
             text = paste(str_split(clade_name, "p_", simplify = T)[,2]))) +
  geom_rect() +
  coord_polar(theta = "y") +
  xlim(c(2,4)) +
  theme_void() +
  scale_fill_discrete()

## genre donut chart (top 15)
genre_data <- data_id %>%
  filter(str_detect(clade_name, "g_")) %>%
  filter(!str_detect(clade_name, "s_")) %>%
  group_by(clade_name = ifelse(row_number() < 15, clade_name = "Other")) %>%
  summarise(across(c(abondance, Percentage), sum)) %>%
  mutate(ymax = cumsum(Percentage)) 
genre_data <- genre_data %>%
  mutate(ymin = c(0, head(genre_data$ymax, n=-1)))

genre_donut <- genre_data %>%
  ggplot(aes(ymax=ymax, ymin=ymin, xmax = 4, xmin=3, fill = clade_name,
             text = paste(str_split(clade_name, "p_", simplify = T)[,2]))) +
  geom_rect() +
  coord_polar(theta = "y") +
  xlim(c(2,4)) +
  theme_void() +
  scale_fill_discrete()
```

```{r bar chart}
bar <- ggplot(taxon_id) +
  
```

```{r bubble chart}
packing <- circleProgressiveLayout(taxon_id, sizetype = 'area')

data = cbind(taxon_id, packing)

dat.gg <- circleLayoutVertices(packing, npoints = 50)

bubble <- ggplot() +
  geom_polygon(data = dat.gg, aes(x, y, group = id, fill = as.factor(id)), color = "black", alpha = 0.6) +
  scale_size_continuous(range = c(1,4)) +
  theme_void() +
  theme(legend.position = "none") +
  coord_equal()

ggplotly(bubble)
```

```{r ggtree}
something <- system.file()
tree <- read.tree(something)

ggtree(tree, aes(color=group), layout = 'circular') + 
  geom_tiplab(size = 1, aes(angle = angle))
```

```{r shiny table}

```

```{r}

```



